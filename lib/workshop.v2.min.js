"use strict";function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(source,!0).forEach(function(key){_defineProperty(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(source).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var ppMap={},graphql2server="https://graphql2.fstk.io";function decryptEthereumKeyPromise(passphrase,ethereumKeyJson){if(window.Worker){var theWorker=new Worker("./lib/eth-key-lib-worker.js");return theWorker.postMessage({passphrase:passphrase,ethereumKeyJson:ethereumKeyJson}),new Promise(function(res){theWorker.onmessage=function(result){theWorker.terminate();var tmpObj=JSON.parse(result.data);if("passphrase"===tmpObj.wrong)return res(null);tmpObj.privateKeyBuffer=window.buffer.Buffer.from(tmpObj.privateKeyBuffer),res(tmpObj)}}).then(function(result){return result||null})}return Promise.resolve(window.EthKeyLibBrowser.DecryptEthereumKeyJson(passphrase,ethereumKeyJson)).then(function(result){return result||null})}function parseMutationResp(content){var resp={};try{resp=JSON.parse(content)}catch(err){return console.error(err),null}return{transaction:jsonpath.query(resp,"$.data.*.transaction")[0],submitToken:jsonpath.query(resp,"$.data.*.submitToken")[0]}}function signTransaction(privateKeyBuffer,txObj){return window.EthKeyLibBrowser.SignTransaction(privateKeyBuffer,txObj)||null}function afterClickSubmitTransactionButton(){var endpoint=window.$("#endpoint").val(),id=window.$("#signin-id").val(),pw=window.$("#signin-pw").val(),passphrase=window.$("#ethk-pp").val(),mutationResp=window.$("#mutation-resp").val();[endpoint,id,pw,passphrase,mutationResp].every(function(content){return 0<content.length})&&(window.$("#endpoint").prop("readonly",!0),window.$("#signin-id").prop("readonly",!0),window.$("#signin-pw").prop("readonly",!0),window.$("#ethk-pp").prop("readonly",!0),window.$("#mutation-resp").prop("readonly",!0),window.$("#submit-transaction").prop("disabled",!0),window.$("#check-txhash").prop("disabled",!0),window.$("#txhash").val("Waiting for transaction"),window.$("#address").val("Waiting for decryption"),window.axios({url:"/to/".concat(endpoint,"/signin"),baseURL:graphql2server,method:"post",withCredentials:!1,data:{query:'\n          mutation signIn {\n            signIn(input: { id: "'.concat(id,'", password: "').concat(pw,'" }) {\n              access_token\n            }\n          }\n      ')}}).then(function(resp){if(!resp.data.data.signIn)return window.$("#signin-id").addClass("bad-form"),window.$("#signin-pw").addClass("bad-form"),null;var access_token=resp.data.data.signIn.access_token;return{endpoint:endpoint,id:id,pw:pw,passphrase:passphrase,access_token:access_token}}).then(function(infoObj){return infoObj?window.axios({url:"/to/".concat(infoObj.endpoint,"/api"),baseURL:graphql2server,method:"post",withCredentials:!1,headers:{Authorization:"Bearer ".concat(infoObj.access_token)},data:{query:"\n            query ethereumKey {\n              ethereumKey {\n                version\n                address\n                crypto\n              }\n            }\n          "}}).then(function(resp){return resp.data.data.ethereumKey?(infoObj.ethereumKey=resp.data.data.ethereumKey,infoObj):null}):null}).then(function(infoObj){return infoObj?(window.$("#address").val("Decrypting the wallet file (key file)..."),Promise.resolve(!0).then(function(_){return void 0!==ppMap["".concat([infoObj.endpoint,infoObj.id,infoObj.pw,infoObj.passphrase].join("-"))]?ppMap["".concat([infoObj.endpoint,infoObj.id,infoObj.pw,infoObj.passphrase].join("-"))]:decryptEthereumKeyPromise(infoObj.passphrase,infoObj.ethereumKey)}).then(function(pp){return pp?(infoObj.pp=pp,infoObj):(window.$("#ethk-pp").addClass("bad-form"),window.$("#address").val("Wrong passphrase"),null)})):null}).then(function(infoObj){return infoObj?(ppMap["".concat([infoObj.endpoint,infoObj.id,infoObj.pw,infoObj.passphrase].join("-"))]=infoObj.pp,window.$("#address").val(infoObj.pp.checksumAddressString),window.$("#address").unbind("click"),window.$("#address").on("click",function(){window.open(infoObj.endpoint.replace("api","explorer")+"/address/"+infoObj.pp.checksumAddressString,"_blank")}),infoObj):null}).then(function(infoObj){if(!infoObj)return null;window.$("#txhash").val("Submitting the transaction...");var parsedMutationResp=parseMutationResp(mutationResp);if(!parsedMutationResp)return window.$("#mutation-resp").addClass("bad-form"),null;var submitTransactionObj={signedTx:signTransaction(infoObj.pp.privateKeyBuffer,parsedMutationResp.transaction),submitToken:parsedMutationResp.submitToken};return submitTransactionObj.signedTx?_objectSpread({},submitTransactionObj,{},infoObj):(window.$("#mutation-resp").addClass("bad-form"),null)}).then(function(infoObj){return infoObj?window.axios({url:"/to/".concat(infoObj.endpoint,"/api"),baseURL:graphql2server,method:"post",withCredentials:!1,headers:{Authorization:"Bearer ".concat(infoObj.access_token)},data:{query:'\n              mutation submitTransaction {\n                submitTransaction(input: { signedTx: "'.concat(infoObj.signedTx,'", submitToken: "').concat(infoObj.submitToken,'" }) {\n                  transactionHash\n                }\n              }\n              ')}}).then(function(resp){return resp.data.data.submitTransaction?(infoObj.latestTxHash=resp.data.data.submitTransaction.transactionHash,infoObj):(window.$("#txhash").val("The transaction is expired or duplicated on blockchain"),window.$("#txhash").addClass("bad-form"),null)}):null}).then(function(infoObj){infoObj&&(window.$("#submit-transaction").html("Transaction Submitted"),window.$("#txhash").val(infoObj.latestTxHash),window.$("#check-txhash").prop("disabled",!1),window.$("#check-txhash").unbind("click"),window.$("#check-txhash").on("click",function(){window.open(infoObj.endpoint.replace("api","explorer")+"/tx/"+infoObj.latestTxHash,"_blank")})),window.$("#endpoint").prop("readonly",!1),window.$("#signin-id").prop("readonly",!1),window.$("#signin-pw").prop("readonly",!1),window.$("#ethk-pp").prop("readonly",!1),window.$("#mutation-resp").prop("readonly",!1)}))}function loadLocalStorage(){return JSON.parse(window.localStorage.getItem("fstnetwork-workshop")||"{}")}function setLocalStorage(obj){return window.localStorage.setItem("fstnetwork-workshop",JSON.stringify(obj))}function reloadHashTable(){var obj=loadLocalStorage();obj.hashTable||(obj.hashTable=[]);var tmpTbody=obj.hashTable.map(function(rowObj,i){return[rowObj,'\n        <tr id="row-'.concat(rowObj.hash,'">\n          <td>').concat(rowObj.original_content,"</td>\n          <td>").concat(""===rowObj.salt?"(empty)":rowObj.salt,"</td>\n          <td>").concat(rowObj.hash,"</td>\n          <td>").concat(rowObj.de_identified_entry,'</td>\n          <td><button style="margin-bottom: 0px;" id="delete-').concat(rowObj.hash,'-row">delete</button></td>\n        </tr>\n    '),i]});if(0===tmpTbody.length)return window.$("#hash-table-body").html("<tr><td>(table is empty)</td></tr>");window.$("#hash-table-body").html(tmpTbody.map(function(_ref){var _ref2=_slicedToArray(_ref,3),rowHtml=(_ref2[0],_ref2[1]);_ref2[2];return rowHtml}).join("")),tmpTbody.forEach(function(_ref3){var _ref4=_slicedToArray(_ref3,3),rowObj=_ref4[0],i=(_ref4[1],_ref4[2]);window.$("#delete-".concat(rowObj.hash,"-row")).unbind("click"),window.$("#delete-".concat(rowObj.hash,"-row")).on("click",function(){window.$("#delete-".concat(rowObj.hash,"-row")).unbind("click"),removeRowFromHashTable(i)})})}function addRowToHashTable(rowObj){if(rowObj){var obj=loadLocalStorage();if(obj.hashTable||(obj.hashTable=[]),obj.hashTable.some(function(_rowObj){return _rowObj.hash===rowObj.hash}))return"duplicated";obj.hashTable.push(rowObj),setLocalStorage(obj),reloadHashTable()}}function removeRowFromHashTable(index){if(!(index<0)){var obj=loadLocalStorage();obj.hashTable&&0!==obj.hashTable.length&&(obj.hashTable.splice(index,1),setLocalStorage(obj),reloadHashTable())}}window.$(function(){window.Bacon.combineAsArray(window.$("#endpoint").asEventStream("input").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$(e.target).val()}).toProperty(""),window.$("#signin-id").asEventStream("input").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$("#signin-pw").removeClass("bad-form"),window.$(e.target).val()}).toProperty(""),window.$("#signin-pw").asEventStream("input").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$("#signin-id").removeClass("bad-form"),window.$(e.target).val()}).toProperty(""),window.$("#ethk-pp").asEventStream("input").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$("#address").val("Waiting for decryption"),window.$(e.target).val()}).toProperty(""),window.$("#mutation-resp").asEventStream("input").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$(e.target).val()}).toProperty("")).onValue(function(arr){window.$("#address").val("Waiting for decryption"),window.$("#txhash").val("Waiting for transaction"),window.$("#txhash").removeClass("bad-form"),window.$("#submit-transaction").html("6. Decrypt Key and Submit Transaction"),arr.every(function(content){return 0<content.length})?(window.$("#mutation-resp").scrollTop(0),window.$("#submit-transaction").prop("disabled",!1)):window.$("#submit-transaction").prop("disabled",!0)}),window.$("#submit-transaction").on("click",afterClickSubmitTransactionButton),Bacon.combineAsArray(window.$("#hash-content").asEventStream("input").map(function(e){return window.$(e.target).val()}).toProperty(""),window.$("#hash-salt").asEventStream("input").map(function(e){return window.$(e.target).val()||""}).toProperty("")).onValue(function(_ref5){var _ref6=_slicedToArray(_ref5,2),content=_ref6[0],salt=_ref6[1];if(content+salt==="")return window.$("#hash-save").prop("disabled",!0),window.$("#hash-result").val(""),window.$("#hash-result-20bytes").val("");var tmpSalt=""===salt?"":window.keccak256(salt);window.$("#hash-save").prop("disabled",!1),window.$("#hash-result").val(window.keccak256(content+tmpSalt)),window.$("#hash-result-20bytes").val(window.$("#hash-result").val().slice(0,40))}),reloadHashTable(),window.$("#hash-save").on("click",function(){addRowToHashTable({hash:window.$("#hash-result").val(),original_content:window.$("#hash-content").val(),salt:window.$("#hash-salt").val(),de_identified_entry:window.$("#hash-result-20bytes").val()})}),$("#go-to-page-api-tx-tool").on("click",function(){$(".page-hashing-tool").addClass("cloak"),$(".page-api-tx-tool").removeClass("cloak")}),$("#go-to-page-hashing-tool").on("click",function(){$(".page-api-tx-tool").addClass("cloak"),$(".page-hashing-tool").removeClass("cloak")}),$("#go-to-page-api-tx-tool").click()});