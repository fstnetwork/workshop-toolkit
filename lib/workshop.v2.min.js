"use strict";function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}var ppMap={},graphql2server="https://graphql2.fstk.io",globalEndpointExplorer="",globalBus=null;function decryptEthereumKeyPromise(passphrase,ethereumKeyJson){if(window.Worker){var theWorker=new Worker("./lib/eth-key-lib-worker.js");return theWorker.postMessage({passphrase:passphrase,ethereumKeyJson:ethereumKeyJson}),new Promise(function(res){theWorker.onmessage=function(result){theWorker.terminate();var tmpObj=JSON.parse(result.data);if("passphrase"===tmpObj.wrong)return res(null);tmpObj.privateKeyBuffer=window.buffer.Buffer.from(tmpObj.privateKeyBuffer),res(tmpObj)}}).then(function(result){return result||null})}return Promise.resolve(window.EthKeyLibBrowser.DecryptEthereumKeyJson(passphrase,ethereumKeyJson)).then(function(result){return result||null})}function parseMutationResp(content){var resp={};try{resp=JSON.parse(content)}catch(err){return console.error(err),null}return{transaction:jsonpath.query(resp,"$.data.*.transaction")[0],submitToken:jsonpath.query(resp,"$.data.*.submitToken")[0]}}function signTransaction(privateKeyBuffer,txObj){return window.EthKeyLibBrowser.SignTransaction(privateKeyBuffer,txObj)||null}function getAuthorizationHeaderUI(){var endpoint=window.$("#endpoint").val(),id=window.$("#signin-id").val(),pw=window.$("#signin-pw").val();[endpoint,id,pw].every(function(content){return 0<content.length})&&window.axios({url:"/to/".concat(endpoint,"/signin"),baseURL:graphql2server,method:"post",withCredentials:!1,data:{query:'\n          mutation signIn {\n            signIn(input: { id: "'.concat(id,'", password: "').concat(pw,'" }) {\n              access_token\n            }\n          }\n      ')}}).then(function(resp){if(!resp.data.data)return window.$("#endpoint").addClass("bad-form"),null;if(!resp.data.data.signIn)return window.$("#signin-id").addClass("bad-form"),window.$("#signin-pw").addClass("bad-form"),window.$("#authorization-header").val("Wrong Sign-In info"),null;var access_token=resp.data.data.signIn.access_token;window.$("#authorization-header").attr("data",access_token),window.$("#authorization-header").val(JSON.stringify({Authorization:"Bearer ".concat(access_token)},null,2)),globalBus.push("COND_AUTHED")})}function getAddressUI(){var endpoint=window.$("#endpoint").val(),id=window.$("#signin-id").val(),pw=window.$("#signin-pw").val(),passphrase=window.$("#ethk-pp").val(),access_token=window.$("#authorization-header").attr("data")||"";[endpoint,id,pw,passphrase,access_token].every(function(content){return 0<content.length})&&window.axios({url:"/to/".concat(endpoint,"/api"),baseURL:graphql2server,method:"post",withCredentials:!1,headers:{Authorization:"Bearer ".concat(access_token)},data:{query:"\n            query ethereumKey {\n              ethereumKey {\n                version\n                address\n                crypto\n              }\n            }\n          "}}).then(function(resp){return resp.data.data.ethereumKey?(window.$("#address").attr("data",resp.data.data.ethereumKey),resp.data.data.ethereumKey):null}).then(function(ethereumKey){return ethereumKey?(window.$("#address").val("Decrypting the wallet file (key file)..."),Promise.resolve(!0).then(function(_){return void 0!==ppMap["".concat([endpoint,id,pw,passphrase].join("-"))]?ppMap["".concat([endpoint,id,pw,passphrase].join("-"))]:decryptEthereumKeyPromise(passphrase,ethereumKey)}).then(function(pp){return pp||(window.$("#ethk-pp").addClass("bad-form"),window.$("#address").val("Wrong passphrase"),null)})):null}).then(function(pp){pp&&(ppMap["".concat([endpoint,id,pw,passphrase].join("-"))]=pp,window.$("#address").val(pp.checksumAddressString),window.$("#address").unbind("click"),window.$("#address").on("click",function(){window.open(endpoint.replace("api","explorer")+"/address/"+pp.checksumAddressString,"_blank")}),globalBus.push("COND_KEY_DECRYPT"))})}function getMutationRespUI(){var endpoint=window.$("#endpoint").val(),id=window.$("#signin-id").val(),pw=window.$("#signin-pw").val(),access_token=window.$("#authorization-header").attr("data")||"",mutationReq=window.$("#mutation-req").val();[endpoint,id,pw,access_token].every(function(content){return 0<content.length})&&window.axios({url:"/to/".concat(endpoint,"/api"),baseURL:graphql2server,method:"post",withCredentials:!1,headers:{Authorization:"Bearer ".concat(access_token)},data:{query:mutationReq}}).then(function(resp){if(!resp.data.data||!resp.data.data)return window.$("#submit-transaction").prop("disabled",!0),window.$("#mutation-resp").addClass("bad-form"),window.$("#mutation-resp").val("Server Error..."),null;var parsedMutationResp=parseMutationResp(JSON.stringify(resp.data));if(!parsedMutationResp)return window.$("#submit-transaction").prop("disabled",!0),window.$("#mutation-resp").addClass("bad-form"),window.$("#mutation-resp").val("Response malformed: ".concat(resp.data)),null;window.$("#mutation-resp").val(JSON.stringify(resp.data,null,2)),window.$("#mutation-resp").attr("data",JSON.stringify(parsedMutationResp)),globalBus.push("COND_MUT_RESP")}).catch(function(error){window.$("#submit-transaction").prop("disabled",!0),window.$("#mutation-resp").addClass("bad-form"),error.response?(window.$("#mutation-resp").val(JSON.stringify(error.response,null,2)),console.error(error.response.data),console.error(error.response.status),console.error(error.response.headers)):error.request?console.error(error.request):console.error("Error",error.message),console.error("Axios Error",error.config)})}function afterClickSubmitTransactionButton(){var endpoint=window.$("#endpoint").val(),id=window.$("#signin-id").val(),pw=window.$("#signin-pw").val(),passphrase=window.$("#ethk-pp").val(),mutationReq=window.$("#mutation-req").val(),mutationResp=window.$("#mutatoin-resp").val(),access_token=window.$("#authorization-header").attr("data")||"",_parsedMutationResp=window.$("#mutation-resp").attr("data")||"";if([endpoint,id,pw,passphrase,mutationReq,mutationResp,access_token,_parsedMutationResp].every(function(content){return 0<content.length})){window.$("#endpoint").prop("readonly",!0),window.$("#signin-id").prop("readonly",!0),window.$("#signin-pw").prop("readonly",!0),window.$("#ethk-pp").prop("readonly",!0),window.$("#mutation-req").prop("readonly",!0),window.$("#submit-transaction").prop("disabled",!0),window.$("#check-txhash").prop("disabled",!0),window.$("#txhash").val("Submitting the transaction...");var parsedMutationResp="";try{parsedMutationResp=JSON.parse(_parsedMutationResp)}catch(err){return console.error(err),null}var signedTx=signTransaction(ppMap["".concat([endpoint,id,pw,passphrase].join("-"))].privateKeyBuffer,parsedMutationResp.transaction),submitToken=parsedMutationResp.submitToken;window.axios({url:"/to/".concat(endpoint,"/api"),baseURL:graphql2server,method:"post",withCredentials:!1,headers:{Authorization:"Bearer ".concat(access_token)},data:{query:'\n            mutation submitTransaction {\n              submitTransaction(input: { signedTx: "'.concat(signedTx,'", submitToken: "').concat(submitToken,'" }) {\n                transactionHash\n              }\n            }\n            ')}}).then(function(resp){if(!resp.data.data.submitTransaction)return window.$("#txhash").val("The transaction is expired or duplicated on blockchain"),window.$("#txhash").addClass("bad-form"),null;var latestTxHash=resp.data.data.submitTransaction.transactionHash;window.$("#submit-transaction").html("Transaction Submitted"),window.$("#txhash").val(latestTxHash),window.$("#check-txhash").prop("disabled",!1),window.$("#check-txhash").unbind("click"),window.$("#check-txhash").on("click",function(){window.open(endpoint.replace("api","explorer")+"/tx/"+latestTxHash,"_blank")}),window.$("#endpoint").prop("readonly",!1),window.$("#signin-id").prop("readonly",!1),window.$("#signin-pw").prop("readonly",!1),window.$("#ethk-pp").prop("readonly",!1),window.$("#mutation-req").prop("readonly",!1)}).catch(function(error){window.$("#txhash").addClass("bad-form"),window.$("#mutation-resp").addClass("bad-form"),error.response?(window.$("#mutation-resp").val(JSON.stringify(error.response,null,2)),console.error(error.response.data),console.error(error.response.status),console.error(error.response.headers)):error.request?console.error(error.request):console.error("Error",error.message),console.error("Axios Error",error.config)})}}function loadLocalStorage(){return JSON.parse(window.localStorage.getItem("fstnetwork-workshop")||"{}")}function setLocalStorage(obj){return window.localStorage.setItem("fstnetwork-workshop",JSON.stringify(obj))}function reloadHashTable(){var obj=loadLocalStorage();obj.hashTable||(obj.hashTable=[]);var tmpTbody=obj.hashTable.map(function(rowObj,i){var de_identified_entry_link="".concat(rowObj.de_identified_entry);return""!==globalEndpointExplorer&&(de_identified_entry_link='<a style="text-decoration-line: underline;" href="'.concat(globalEndpointExplorer,"/address/0x").concat(rowObj.de_identified_entry,'" target="_blank">').concat(rowObj.de_identified_entry,"</a>")),[rowObj,'\n        <tr id="row-'.concat(rowObj.hash,'">\n          <td>').concat(rowObj.original_content,"</td>\n          <td>").concat(""===rowObj.salt?"(empty)":rowObj.salt,"</td>\n          <td>").concat(rowObj.hash,"</td>\n          <td>").concat(de_identified_entry_link,'</td>\n          <td><button style="margin-bottom: 0px;" id="delete-').concat(rowObj.hash,'-row">delete</button></td>\n        </tr>\n    '),i]});if(0===tmpTbody.length)return window.$("#hash-table-body").html("<tr><td>(table is empty)</td></tr>");window.$("#hash-table-body").html(tmpTbody.map(function(_ref){var _ref2=_slicedToArray(_ref,3),rowHtml=(_ref2[0],_ref2[1]);_ref2[2];return rowHtml}).join("")),tmpTbody.forEach(function(_ref3){var _ref4=_slicedToArray(_ref3,3),rowObj=_ref4[0],i=(_ref4[1],_ref4[2]);window.$("#delete-".concat(rowObj.hash,"-row")).unbind("click"),window.$("#delete-".concat(rowObj.hash,"-row")).on("click",function(){window.$("#delete-".concat(rowObj.hash,"-row")).unbind("click"),removeRowFromHashTable(i)})})}function addRowToHashTable(rowObj){if(rowObj){var obj=loadLocalStorage();if(obj.hashTable||(obj.hashTable=[]),obj.hashTable.some(function(_rowObj){return _rowObj.hash===rowObj.hash}))return"duplicated";obj.hashTable.push(rowObj),setLocalStorage(obj),reloadHashTable()}}function removeRowFromHashTable(index){if(!(index<0)){var obj=loadLocalStorage();obj.hashTable&&0!==obj.hashTable.length&&(obj.hashTable.splice(index,1),setLocalStorage(obj),reloadHashTable())}}window.$(function(){globalBus=new window.Bacon.Bus;var endpointChangeStream=window.$("#endpoint").asEventStream("change").map(function(e){window.$(e.target).removeClass("bad-form"),window.$(e.target).val(window.$(e.target).val().replace("fst.network/api","fst.network").replace("fstk.io/api","fstk.io").replace("fst.dev/api","fst.dev").replace("fstk.dev/api","fstk.dev").replace("fstnetwork.dev/api","fstnetwork.dev").replace("fst.network/explorer","fst.network").replace("fstk.io/explorer","fstk.io").replace("fst.dev/explorer","fst.dev").replace("fstk.dev/explorer","fstk.dev").replace("fstnetwork.dev/explorer","fstnetwork.dev").replace("fst.network/signin","fst.network").replace("fstk.io/signin","fstk.io").replace("fst.dev/signin","fst.dev").replace("fstk.dev/signin","fstk.dev").replace("fstnetwork.dev/signin","fstnetwork.dev"));var tmpEndpoint=window.$(e.target).val();return globalEndpointExplorer=tmpEndpoint.replace("api.","explorer.").replace("https://","http://").replace("http://","//"),reloadHashTable(),window.$("#explorer-preview").html('(The Blockchain Explorer for the Data Entry is at: <a id="explorer-preview-link" href="'.concat(globalEndpointExplorer,'" target="_blank">').concat(globalEndpointExplorer,"</a>)")),tmpEndpoint}).toProperty(""),signInIdChangeStream=window.$("#signin-id").asEventStream("change").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$("#signin-pw").removeClass("bad-form"),window.$(e.target).val()}).toProperty(""),signInPwChangeStream=window.$("#signin-pw").asEventStream("change").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$("#signin-id").removeClass("bad-form"),window.$(e.target).val()}).toProperty(""),ethKPPChangeStream=window.$("#ethk-pp").asEventStream("change").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$("#address").val(""),window.$(e.target).val()}).toProperty(""),mutationReqChangeStream=window.$("#mutation-req").asEventStream("change").map(function(e){return window.$(e.target).removeClass("bad-form"),window.$(e.target).val()}).toProperty("");window.Bacon.combineAsArray(endpointChangeStream,signInIdChangeStream,signInPwChangeStream).onValue(function(arr){console.log(arr),window.$("#authorization-header").val(""),window.$("#address").val(""),window.$("#mutation-resp").val(""),window.$("#txhash").val(""),window.$("#submit-transaction").prop("disabled",!0),window.$("#check-txhash").prop("disabled",!0),window.$("#authorization-header").removeClass("bad-form"),window.$("#address").removeClass("bad-form"),window.$("#mutation-resp").removeClass("bad-form"),window.$("#txhash").removeClass("bad-form"),arr.every(function(content){return 0<content.length})&&getAuthorizationHeaderUI()}),window.Bacon.combineAsArray(globalBus.filter(function(cond){return"COND_AUTHED"===cond}),ethKPPChangeStream).onValue(function(arr){console.log(arr),window.$("#address").val(""),window.$("#mutation-resp").val(""),window.$("#txhash").val(""),window.$("#submit-transaction").prop("disabled",!0),window.$("#check-txhash").prop("disabled",!0),window.$("#address").removeClass("bad-form"),window.$("#mutation-resp").removeClass("bad-form"),window.$("#txhash").removeClass("bad-form"),arr.every(function(content){return 0<content.length})&&getAddressUI()}),window.Bacon.combineAsArray(globalBus.filter(function(cond){return"COND_AUTHED"===cond}),mutationReqChangeStream).onValue(function(arr){console.log(arr),window.$("#mutation-resp").val(""),window.$("#txhash").val(""),window.$("#submit-transaction").prop("disabled",!0),window.$("#check-txhash").prop("disabled",!0),window.$("#mutation-resp").removeClass("bad-form"),window.$("#txhash").removeClass("bad-form"),arr.every(function(content){return 0<content.length})&&getMutationRespUI()}),window.Bacon.combineAsArray(globalBus.filter(function(cond){return"COND_AUTHED"===cond}),globalBus.filter(function(cond){return"COND_MUT_RESP"===cond}),globalBus.filter(function(cond){return"COND_KEY_DECRYPT"===cond})).onValue(function(arr){console.log(arr),window.$("#submit-transaction").html("6. Sign and Submit Transaction"),window.$("#submit-transaction").prop("disabled",!1)}),window.$("#submit-transaction").on("click",afterClickSubmitTransactionButton),Bacon.combineAsArray(window.$("#hash-content").asEventStream("input").map(function(e){return window.$(e.target).val()}).toProperty(""),window.$("#hash-salt").asEventStream("input").map(function(e){return window.$(e.target).val()||""}).toProperty("")).onValue(function(_ref5){var _ref6=_slicedToArray(_ref5,2),content=_ref6[0],salt=_ref6[1];if(content+salt==="")return window.$("#hash-save").prop("disabled",!0),window.$("#hash-result").val(""),window.$("#hash-result-20bytes").val("");var tmpSalt=""===salt?"":window.keccak256(salt);window.$("#hash-save").prop("disabled",!1),window.$("#hash-result").val(window.keccak256(content+tmpSalt)),window.$("#hash-result-20bytes").val(window.$("#hash-result").val().slice(0,40))}),reloadHashTable(),window.$("#hash-save").on("click",function(){addRowToHashTable({hash:window.$("#hash-result").val(),original_content:window.$("#hash-content").val(),salt:window.$("#hash-salt").val(),de_identified_entry:window.$("#hash-result-20bytes").val()})}),window.$("#go-to-page-api-tx-tool").on("click",function(){window.$(".page-hashing-tool").addClass("cloak"),window.$(".page-api-tx-tool").removeClass("cloak")}),window.$("#go-to-page-hashing-tool").on("click",function(){window.$(".page-api-tx-tool").addClass("cloak"),window.$(".page-hashing-tool").removeClass("cloak")}),window.$("#go-to-page-api-tx-tool").click(),$("#endpoint").trigger("change"),$("#sigin-id").trigger("change"),$("#sigin-pw").trigger("change"),$("#ethk-pp").trigger("change"),$("#mutation-req").trigger("change")});