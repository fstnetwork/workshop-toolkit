"use strict";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable})),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(source,!0).forEach(function(key){_defineProperty(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(source).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var ppMap={},graphql2server="https://graphql2.fstk.io";function decryptEthereumKeyPromise(passphrase,ethereumKeyJson){if(window.Worker){var theWorker=new Worker("./lib/eth-key-lib-worker.js");return theWorker.postMessage({passphrase:passphrase,ethereumKeyJson:ethereumKeyJson}),new Promise(function(res){theWorker.onmessage=function(result){theWorker.terminate();var tmpObj=JSON.parse(result.data);if("passphrase"===tmpObj.wrong)return res(null);tmpObj.privateKeyBuffer=window.buffer.Buffer.from(tmpObj.privateKeyBuffer),res(tmpObj)}}).then(function(result){return result||null})}return Promise.resolve(window.EthKeyLibBrowser.DecryptEthereumKeyJson(passphrase,ethereumKeyJson)).then(function(result){return result||null})}function parseMutationResp(content){var resp={};try{resp=JSON.parse(content)}catch(err){return console.error(err),null}return{transaction:jsonpath.query(resp,"$.data.*.transaction")[0],submitToken:jsonpath.query(resp,"$.data.*.submitToken")[0]}}function signTransaction(privateKeyBuffer,txObj){return window.EthKeyLibBrowser.SignTransaction(privateKeyBuffer,txObj)||null}function afterClickSubmitTransactionButton(){var endpoint=window.$("#endpoint").val(),id=window.$("#signin-id").val(),pw=window.$("#signin-pw").val(),passphrase=window.$("#ethk-pp").val(),mutationResp=window.$("#mutation-resp").val();[endpoint,id,pw,passphrase,mutationResp].every(function(content){return 0<content.length})&&(window.$("#endpoint").prop("readonly",!0),window.$("#signin-id").prop("readonly",!0),window.$("#signin-pw").prop("readonly",!0),window.$("#ethk-pp").prop("readonly",!0),window.$("#mutation-resp").prop("readonly",!0),window.$("#submit-transaction").prop("disabled",!0),window.$("#check-txhash").prop("disabled",!0),window.$("#txhash").val("Waiting for transaction"),window.$("#address").val("Waiting for decryption"),window.axios({url:"/to/".concat(endpoint,"/signin"),baseURL:graphql2server,method:"post",withCredentials:!1,data:{query:'\n          mutation signIn {\n            signIn(input: { id: "'.concat(id,'", password: "').concat(pw,'" }) {\n              access_token\n            }\n          }\n      ')}}).then(function(resp){if(!resp.data.data.signIn)return console.log("fuick!!!"),window.$("#signin-id").addClass("bad-form"),window.$("#signin-pw").addClass("bad-form"),null;var access_token=resp.data.data.signIn.access_token;return{endpoint:endpoint,id:id,pw:pw,passphrase:passphrase,access_token:access_token}}).then(function(infoObj){return infoObj?window.axios({url:"/to/".concat(infoObj.endpoint,"/api"),baseURL:graphql2server,method:"post",withCredentials:!1,headers:{Authorization:"Bearer ".concat(infoObj.access_token)},data:{query:"\n            query ethereumKey {\n              ethereumKey {\n                version\n                address\n                crypto\n              }\n            }\n          "}}).then(function(resp){return resp.data.data.ethereumKey?(infoObj.ethereumKey=resp.data.data.ethereumKey,infoObj):null}):null}).then(function(infoObj){return infoObj?(window.$("#address").val("Decrypting the wallet file (key file)..."),Promise.resolve(!0).then(function(_){return void 0!==ppMap["".concat([infoObj.endpoint,infoObj.id,infoObj.pw,infoObj.passphrase].join("-"))]?ppMap["".concat([infoObj.endpoint,infoObj.id,infoObj.pw,infoObj.passphrase].join("-"))]:decryptEthereumKeyPromise(infoObj.passphrase,infoObj.ethereumKey)}).then(function(pp){return pp?(infoObj.pp=pp,infoObj):(window.$("#ethk-pp").addClass("bad-form"),window.$("#address").val("Wrong passphrase"),null)})):null}).then(function(infoObj){return infoObj?(ppMap["".concat([infoObj.endpoint,infoObj.id,infoObj.pw,infoObj.passphrase].join("-"))]=infoObj.pp,window.$("#address").val(infoObj.pp.checksumAddressString),window.$("#address").unbind("click"),window.$("#address").on("click",function(){window.open(infoObj.endpoint.replace("api","explorer")+"/address/"+infoObj.pp.checksumAddressString,"_blank")}),infoObj):null}).then(function(infoObj){if(!infoObj)return null;window.$("#txhash").val("Submitting the transaction...");var parsedMutationResp=parseMutationResp(mutationResp);if(!parsedMutationResp)return window.$("#mutation-resp").addClass("bad-form"),null;var submitTransactionObj={signedTx:signTransaction(infoObj.pp.privateKeyBuffer,parsedMutationResp.transaction),submitToken:parsedMutationResp.submitToken};return submitTransactionObj.signedTx?_objectSpread({},submitTransactionObj,{},infoObj):(window.$("#mutation-resp").addClass("bad-form"),null)}).then(function(infoObj){return infoObj?window.axios({url:"/to/".concat(infoObj.endpoint,"/api"),baseURL:graphql2server,method:"post",withCredentials:!1,headers:{Authorization:"Bearer ".concat(infoObj.access_token)},data:{query:'\n              mutation submitTransaction {\n                submitTransaction(input: { signedTx: "'.concat(infoObj.signedTx,'", submitToken: "').concat(infoObj.submitToken,'" }) {\n                  transactionHash\n                }\n              }\n              ')}}).then(function(resp){return resp.data.data.submitTransaction?(infoObj.latestTxHash=resp.data.data.submitTransaction.transactionHash,infoObj):(window.$("#txhash").val("The transaction is expired or duplicated on blockchain"),window.$("#txhash").addClass("bad-form"),null)}):null}).then(function(infoObj){infoObj&&(window.$("#submit-transaction").html("Transaction Submitted"),window.$("#txhash").val(infoObj.latestTxHash),window.$("#check-txhash").prop("disabled",!1),window.$("#check-txhash").unbind("click"),window.$("#check-txhash").on("click",function(){window.open(infoObj.endpoint.replace("api","explorer")+"/tx/"+infoObj.latestTxHash,"_blank")})),window.$("#endpoint").prop("readonly",!1),window.$("#signin-id").prop("readonly",!1),window.$("#signin-pw").prop("readonly",!1),window.$("#ethk-pp").prop("readonly",!1),window.$("#mutation-resp").prop("readonly",!1)}))}window.$(function(){window.Bacon.combineAsArray(window.$("#endpoint").asEventStream("input").map(function(e){return $(e.target).removeClass("bad-form"),$(e.target).val()}).toProperty(""),window.$("#signin-id").asEventStream("input").map(function(e){return $(e.target).removeClass("bad-form"),$("signin-pw").removeClass("bad-form"),$(e.target).val()}).toProperty(""),window.$("#signin-pw").asEventStream("input").map(function(e){return $(e.target).removeClass("bad-form"),$("signin-id").removeClass("bad-form"),$(e.target).val()}).toProperty(""),window.$("#ethk-pp").asEventStream("input").map(function(e){return $(e.target).removeClass("bad-form"),window.$("#address").val("Waiting for decryption"),$(e.target).val()}).toProperty(""),window.$("#mutation-resp").asEventStream("input").map(function(e){return $(e.target).removeClass("bad-form"),$(e.target).val()}).toProperty("")).onValue(function(arr){window.$("#txhash").val("Waiting for transaction"),window.$("#txhash").removeClass("bad-form"),window.$("#submit-transaction").html("Decrypt Key and Submit Transaction"),arr.every(function(content){return 0<content.length})?($("#mutation-resp").scrollTop(0),window.$("#submit-transaction").prop("disabled",!1)):window.$("#submit-transaction").prop("disabled",!0)}),window.$("#submit-transaction").on("click",afterClickSubmitTransactionButton)});